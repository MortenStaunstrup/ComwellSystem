@page "/MyGoals"
@using System.Text.Json
@using ComwellWeb.Services.Interfaces
@using Core
@inject IJSRuntime JS
@inject IUserService UserService
@inject ICommentService CommentService
@inject INotificationService NotificationService
@inject ISubGoalService SubGoalService

<div class="mysubgoals-root">
    <div class="dashboard-container">
        <div class="left-section">
            <h2>@PageTitle</h2>

            <div class="progress-and-name">
                <h3>Din Procces</h3>
                <div class="progress-container">
                    <div class="progress-bar" style="width: @GetPctCompleted()%;"></div>
                </div>
            </div>

            <div class="filter-container">
                <label for="statusFilter">Filtrer efter status:</label>
                <select id="statusFilter" class="status-select" @onchange="OnFilterChanged">
                    <option value="all">Alle</option>
                    <option value="completed">Fuldførte</option>
                    <option value="notcompleted">Ikke fuldførte</option>
                </select>
            </div>

            @if (!FilteredPlan.Any())
            {
                <p>Ingen mål matcher filteret.</p>
            }
            else
            {
                @if (selectedFilter == "all")
                {
                    <p>@FilteredPlan.Count delmål</p>
                }
                else if (selectedFilter == "completed")
                {
                    <p>@FilteredPlan.Count delmål færdige</p>
                }
                else
                {
                    <p>@FilteredPlan.Count delmål mangler</p>
                }

                <div class="assignments-container">
                    @foreach (var sg in FilteredPlan)
                    {
                        <div class="assignment-card">
                            <h4 class="assignment-title">@sg.SubGoalName</h4>
                            <p class="assignment-description">@sg.SubGoalDescription</p>
                            <button class="toggle-button" @onclick="() => ToggleExpand(sg.SubGoalId)">
                                @(Expanded.Contains(sg.SubGoalId) ? "▼ Vis mindre" : "▶ Vis mere")
                            </button>

                            @if (Expanded.Contains(sg.SubGoalId))
                            {
                                <div class="subgoal-details">
                                    <p>Type: @sg.SubGoalType</p>
                                    <p>Status: @(sg.SubGoalStatus ? "Fuldført" : "Ikke fuldført")</p>

                                    <!-- Kommentarer -->
                                    <div class="comment-section">
                                        <h6>Kommentarer</h6>
                                        @foreach (var comment in CommentMap.GetValueOrDefault(sg.SubGoalId, new List<Comment>()))
                                        {
                                            <div class="comment">
                                                <span class="date">@comment.CommentDate.ToString("dd-MM-yyyy HH:mm")</span>
                                                <p>@comment.CommentContent</p>
                                            </div>
                                        }

                                        <input placeholder="Skriv kommentar" value="@NewComment[sg.SubGoalId]"
                                               @oninput="e => NewComment[sg.SubGoalId] = e.Value?.ToString()" />
                                        <button @onclick="() => SendComment(sg.SubGoalId)" disabled="@IsReadOnly">
                                            Send
                                        </button>
                                    </div>

                                    <!-- Mellemmål og minimål -->
                                    <div class="middle-goals">
                                        @foreach (var mg in sg.MiddleGoals)
                                        {
                                            <div class="middle-goal">
                                                <strong>@mg.Name</strong> (@(mg.Status ? "✔️" : ""))

                                                <ul>
                                                    @foreach (var mm in mg.MiniGoals)
                                                    {
                                                        <li>
                                                            <label>
                                                                <input type="checkbox"
                                                                       @onchange="_ => ToggleMiniGoalStatus(sg.SubGoalId, mg, mm)"
                                                                       checked="@mm.Status"
                                                                       disabled="@IsReadOnly" />
                                                                @mm.Name
                                                            </label>

                                                            <input type="checkbox"
                                                                   @onchange="_ => ToggleSelectedMiniGoal(sg.SubGoalId, mm)"
                                                                   checked="@(SelectedMiniGoals.TryGetValue(sg.SubGoalId, out var selectedList) && selectedList.Contains(mm))"
                                                                   disabled="@IsReadOnly" /> Vælg
                                                        </li>
                                                    }
                                                </ul>
                                            </div>
                                        }
                                    </div>

                                    @if (SelectedMiniGoals.TryGetValue(sg.SubGoalId, out var selectedGoals) && selectedGoals.Any())
                                    {
                                        <button class="action-button"
                                                @onclick="() => CompleteSubGoal(sg, selectedGoals)"
                                                disabled="@(_sending || IsReadOnly)">
                                            Afslut valgte minimål
                                        </button>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

@code {
    private User CurrentUser;
    private User UserModel;
    private bool HasAccess;
    private string PageTitle;
    private Dictionary<int, List<MiniGoal>> SelectedMiniGoals = new();
    private List<SubGoal> FullPlan = new();
    private List<SubGoal> FilteredPlan = new();
    private Dictionary<int, List<Comment>> CommentMap = new();
    private Dictionary<int, string> NewComment = new();
    private Dictionary<int, string> Errors = new();
    private HashSet<int> Expanded = new();
    private bool IsReadOnly;
    private bool _sending = false;

    [Parameter] public int? studentId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var userJson = await JS.InvokeAsync<string>("localStorage.getItem", "user");
        CurrentUser = JsonSerializer.Deserialize<User>(userJson!);

        var viewId = studentId ?? CurrentUser.UserId;
        IsReadOnly = viewId != CurrentUser.UserId;
        UserModel = await UserService.GetUserByUserId(viewId);
        HasAccess = CurrentUser.Role == "KitchenManager" || viewId == CurrentUser.UserId;
        PageTitle = CurrentUser.Role == "KitchenManager" ? UserModel.UserName : "Elevplan";

        FullPlan = UserModel.StudentPlan;
        ApplyFilter();

        foreach (var sg in FullPlan)
        {
            var comments = await CommentService.GetCommentsBySubGoalId(sg.SubGoalId, viewId);
            CommentMap[sg.SubGoalId] = comments?.ToList() ?? new List<Comment>();
            NewComment[sg.SubGoalId] = string.Empty;
            Errors[sg.SubGoalId] = string.Empty;
        }
    }

    private void ApplyFilter()
    {
        FilteredPlan = selectedFilter switch
        {
            "completed" => FullPlan.Where(s => s.SubGoalStatus).ToList(),
            "notcompleted" => FullPlan.Where(s => !s.SubGoalStatus).ToList(),
            _ => FullPlan.ToList()
        };
    }

    private string selectedFilter = "all";
    private void OnFilterChanged(ChangeEventArgs e)
    {
        selectedFilter = e.Value?.ToString()?.ToLower() ?? "all";
        ApplyFilter();
    }

    private void ToggleExpand(int id)
    {
        if (!Expanded.Add(id)) Expanded.Remove(id);
    }

    private async Task SendComment(int sgId)
    {
        if (string.IsNullOrWhiteSpace(NewComment[sgId]))
        {
            Errors[sgId] = "Kommentaren må ikke være tom.";
            return;
        }

        var newC = new Comment
        {
            CommentDate = DateTime.Now,
            CommentSubGoalId = sgId,
            CommentContent = NewComment[sgId],
            CommentSenderId = CurrentUser.UserId,
            StudentId = studentId ?? CurrentUser.UserId
        };

        try
        {
            CommentService.AddComment(newC);
            CommentMap[sgId].Add(newC);
            NewComment[sgId] = string.Empty;
        }
        catch (Exception ex)
        {
            Errors[sgId] = ex.Message;
        }
    }

    private void ToggleMiniGoalStatus(int sgId, MiddleGoal mg, MiniGoal mm)
    {
        mm.Status = !mm.Status;
        // TODO: Opdater database
    }

    private void ToggleSelectedMiniGoal(int sgId, MiniGoal mm)
    {
        if (!SelectedMiniGoals.ContainsKey(sgId))
            SelectedMiniGoals[sgId] = new List<MiniGoal>();

        var selected = SelectedMiniGoals[sgId];
        if (selected.Contains(mm))
            selected.Remove(mm);
        else
            selected.Add(mm);
    }

    private async Task CompleteSubGoal(SubGoal sg, List<MiniGoal> selectedGoals)
    {
        if (_sending) return;
        _sending = true;

        try
        {
            var responsibleId = UserModel.UserIdResponsible;
            if (responsibleId == null)
            {
                Errors[sg.SubGoalId] = "Ingen ansvarlig bruger fundet.";
                return;
            }

            var newId = await NotificationService.GetMaxNotificationIdAsync();

            foreach (var mm in selectedGoals)
            {
                var noti = new Notification
                {
                    NotificationId = ++newId,
                    UserId = responsibleId,
                    SenderId = CurrentUser.UserId,
                    MiniGoalName = mm.Name,
                    NotificationContent = $"{CurrentUser.UserName} har færdiggjort et minimål: '{mm.Name}'",
                    TimeStamp = DateTime.Now
                };

                await NotificationService.SendNotificationAsync(noti);
                mm.Status = true;
            }

            sg.SubGoalStatus = true;
            SelectedMiniGoals[sg.SubGoalId].Clear();
        }
        catch (Exception ex)
        {
            Errors[sg.SubGoalId] = $"Fejl ved afslutning af delmål: {ex.Message}";
        }
        finally
        {
            _sending = false;
            StateHasChanged();
        }
    }

    private string GetPctCompleted()
    {
        if (FullPlan == null || !FullPlan.Any()) return "0";
        var pct = 100.0 * FullPlan.Count(s => s.SubGoalStatus) / FullPlan.Count;
        return Math.Truncate(pct).ToString("F0");
    }
}
